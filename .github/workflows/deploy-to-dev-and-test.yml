name: Deploy to dev and test
concurrency: dev_environment
on:
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          cache: 'yarn'
      - name: Set up Fastly CLI
        uses: fastly/compute-actions/setup@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          cli_version: '10.2.0'
      - run: yarn
      - name: Set service-name
        id: service-name
        run: echo "SERVICE_NAME=fastly-compute-application-dev-pr-${{ github.event.number }}" >> "$GITHUB_OUTPUT"
      - run: fastly service delete --quiet --service-name ${{ steps.service-name.outputs.SERVICE_NAME }} --force --token ${{ secrets.FASTLY_API_KEY }} || true
      - run: sed -i 's/^name = ".*"/name = "${{ steps.service-name.outputs.SERVICE_NAME }}"/g' fastly.toml
      - run: fastly compute publish --verbose -i --token ${{ secrets.FASTLY_API_KEY }}
      - run: fastly domain list --quiet --version latest --json --token ${{ secrets.FASTLY_API_KEY }} | jq -r '.[0].Name'
      - name: Set domain
        id: domain
        run: echo "DOMAIN=$(fastly domain list --quiet --version latest --json --token ${{ secrets.FASTLY_API_KEY }} | jq -r '.[0].Name')" >> "$GITHUB_OUTPUT"
      - name: Add domain to summary
        run: echo 'This pull-request has been deployed to Fastly and is available at <https://${{ steps.domain.outputs.DOMAIN }}> ðŸš€' >> $GITHUB_STEP_SUMMARY
      - run: npm run test:integration
        env:
          HOST: "https://${{ steps.domain.outputs.DOMAIN }}"